From 0cd2537c8bcb2b883a929d22971e122c12623266 Mon Sep 17 00:00:00 2001
From: "freedom.tan" <freedom.tan@mediatek.com>
Date: Wed, 20 May 2015 14:42:22 +0800
Subject: [PATCH 16/16] usb hacking

---
 arch/arm64/boot/dts/mediatek/mt8173-evb.dts | 13 +++++++++++++
 arch/arm64/boot/dts/mediatek/mt8173.dtsi    | 19 ++++++++-----------
 2 files changed, 21 insertions(+), 11 deletions(-)

diff --git a/arch/arm64/boot/dts/mediatek/mt8173-evb.dts b/arch/arm64/boot/dts/mediatek/mt8173-evb.dts
index 4320089..303c100 100644
--- a/arch/arm64/boot/dts/mediatek/mt8173-evb.dts
+++ b/arch/arm64/boot/dts/mediatek/mt8173-evb.dts
@@ -348,6 +348,14 @@
 			bias-pull-down = <MTK_PUPD_SET_R1R0_10>;
 		};
 	};
+
+	usb_pins: usb@0 {
+		pins1 {
+			pinmux = <MT8173_PIN_101_MSDC2_DAT1__FUNC_GPIO101>;
+			output-high;
+			bias-disable;
+		};
+	};
 };
 
 /*
@@ -446,6 +454,11 @@
 	clock-frequency = <100000>;
 };
 
+&usb {
+	pinctrl-names = "default";
+	pinctrl-0 = <&usb_pins>;
+};
+
 &u3phy {
 	p1-gpio = <&pio 130 0>;
 };
diff --git a/arch/arm64/boot/dts/mediatek/mt8173.dtsi b/arch/arm64/boot/dts/mediatek/mt8173.dtsi
index 2d50261..165eae5 100644
--- a/arch/arm64/boot/dts/mediatek/mt8173.dtsi
+++ b/arch/arm64/boot/dts/mediatek/mt8173.dtsi
@@ -288,12 +288,14 @@
 			compatible = "mediatek,mt8173-scpsys";
 			#power-domain-cells = <1>;
 			reg = <0 0x10006000 0 0x1000>;
+			#clock-cells = <1>;
 			clocks = <&topckgen CLK_TOP_VDEC_SEL>,
 				 <&topckgen CLK_TOP_MFG_SEL>,
 				 <&topckgen CLK_TOP_VENC_SEL>,
 				 <&topckgen CLK_TOP_MM_SEL>,
-				 <&topckgen CLK_TOP_VENC_LT_SEL>;
-			clock-names = "vdec", "mfg", "venc", "disp", "ven2";
+				 <&topckgen CLK_TOP_VENC_LT_SEL>,
+				 <&topckgen CLK_TOP_USB30_SEL>;
+			clock-names = "vdec", "mfg", "venc", "disp", "ven2", "vusb";
 		};
 
 		pwrap: pwrap@1000d000 {
@@ -393,22 +395,17 @@
 			status = "disabled";
 		};
 
-		scpsys: scpsys@10001000 {
-			compatible = "mediatek,mt8173-scpsys";
-			reg = <0 0x10001000 0 0x1000>, <0 0x10006000 0 0x1000>, <0 0x13fff000 0 0x1000>;
-			#clock-cells = <1>;
-		};
-
 		u3phy: usb-phy@11271000 {
 			compatible = "mediatek,mt8173-u3phy";
 			reg = <0 0x11271000 0 0x3000>,
 				<0 0x11280000 0 0x20000>;
+			power-domains = <&scpsys MT8173_POWER_DOMAIN_USB>;
 			usb-host = <&usb>;
 			reg-vusb33-supply = <&mt6397_vusb_reg>;
 			usb3_ref_clk = <&apmixedsys>;
-			clocks = <&scpsys 10>,
-				<&pericfg PERI_USB0>,
-				<&pericfg PERI_USB1>;
+			clocks = <&topckgen CLK_TOP_USB30_SEL>,
+				<&pericfg CLK_PERI_USB0>,
+				<&pericfg CLK_PERI_USB1>;
 			clock-names = "scp_sys_usb", "peri_usb0", "peri_usb1";
 		};
 
-- 
1.9.1

